(function(){var i,d,f,k,a,j,g,b,e,h={}.hasOwnProperty,c=function(o,m){for(var l in m){if(h.call(m,l)){o[l]=m[l]}}function n(){this.constructor=o}n.prototype=m.prototype;o.prototype=new n();o.__super__=m.prototype;return o};b=(function(){var m,n,l;o.STONE_IMAGE_WIDTH=50;o.STONE_IMAGE_HEIGHT=50;o.VOID="images/void.jpg";o.BLACK="images/black.jpg";o.WHITE="images/white.jpg";o.HINT_B="images/hintB.jpg";o.HINT_W="images/hintW.jpg";m=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];function o(q,r,p){this.gameSize=r!=null?r:8;this.stoneDispWidth=p!=null?p:1;this.fps=q.fps;this.num_stone=this.gameSize*this.gameSize;this.scale=this.stoneDispWidth/o.STONE_IMAGE_WIDTH;this.SPRITES=[];this.BoardState=[];this.turn=1;this.start=false;this.BlackStone=this.WhiteStone=0;this.players=[0,0];this.records=[];this.play_pos=0;this.replay_mode=false;q.preload([o.VOID,o.BLACK,o.WHITE,o.HINT_B,o.HINT_W])}o.prototype.setCPUs=function(p){this.cpus=p};o.prototype.isInBoard=function(p,q){return(p>=0)&&(p<this.gameSize)&&(q>=0)&&(q<this.gameSize)};o.prototype.xy2pos=function(p,q){return p+q*this.gameSize};o.prototype.pos2xy=function(p){return[p%this.gameSize,Math.floor(p/this.gameSize)]};o.prototype._getSprite=function(u){var z,q,p,w,v,t,s,r;t=[o.STONE_IMAGE_WIDTH,o.STONE_IMAGE_HEIGHT],p=t[0],z=t[1];q=new Sprite(p,z);q.image=new Surface(p*5,z);q.pos=u;s=this.pos2xy(u),w=s[0],v=s[1];q.frame=0;q.scale(this.scale,this.scale);r=[w*p*this.scale,v*z*this.scale],q.x=r[0],q.y=r[1];q.image.draw(enchant.Game.instance.assets[o.VOID],0,0,p,z,0,0,p,z);q.image.draw(enchant.Game.instance.assets[o.BLACK],0,0,p,z,p,0,p,z);q.image.draw(enchant.Game.instance.assets[o.WHITE],0,0,p,z,p*2,0,p,z);q.image.draw(enchant.Game.instance.assets[o.HINT_B],0,0,p,z,p*3,0,p,z);q.image.draw(enchant.Game.instance.assets[o.HINT_W],0,0,p,z,p*4,0,p,z);return q};o.prototype.createBoard=function(){var r,q,p;this.SPRITES=[];for(r=q=0,p=this.num_stone;0<=p?q<p:q>p;r=0<=p?++q:--q){this.SPRITES.push(this._getSprite(r))}this.firstScene();return this.SPRITES};o.prototype.firstScene=function(){var s,p,r,q;for(p=r=0,q=this.num_stone;0<=q?r<q:r>q;p=0<=q?++r:--r){this.SPRITES[p].frame=0;this.BoardState[p]=0}s=this.gameSize*(Math.floor(this.gameSize/2-1))+Math.floor(this.gameSize/2-1);this.SPRITES[s].frame=this.SPRITES[s+this.gameSize+1].frame=2;this.BoardState[s]=this.BoardState[s+this.gameSize+1]=-1;this.SPRITES[s+1].frame=this.SPRITES[s+this.gameSize].frame=1;this.BoardState[s+1]=this.BoardState[s+this.gameSize]=1;this.BlackStone=this.WhiteStone=2;return document.myForm.black.value=document.myForm.white.value=2};o.prototype.checkInvert=function(){var J,E,I,H,D,C,G,w,F,B,z,s,r,A,v,u,t,q,p;E=[];F=(-1)*this.turn;for(w=s=0,A=this.num_stone;0<=A?s<A:s>A;w=0<=A?++s:--s){if(this.BoardState[w]===0){v=this.pos2xy(w),B=v[0],z=v[1];for(G=r=0,u=m.length;0<=u?r<u:r>u;G=0<=u?++r:--r){t=[m[G][0],m[G][1]],D=t[0],C=t[1];q=[1,D,C],J=q[0],I=q[1],H=q[2];while(this.isInBoard(B+I,z+H)&&(this.BoardState[this.xy2pos(B+I,z+H)]===F)){p=[J+1,I+D,H+C],J=p[0],I=p[1],H=p[2]}if(this.isInBoard(B+I,z+H)&&(this.BoardState[this.xy2pos(B+I,z+H)]===this.turn)&&(J>1)){this.BoardState[w]=2;this.SPRITES[w].frame=(this.turn>0?3:4);E.push(w);break}}}}return E};o.prototype.showStone=function(r,s){var w,q,v,t,p,u;if(s==null){s={delay:0,turn:this.turn}}t=[null,null],q=t[0],v=t[1];if(s.pos){p=this.pos2xy(s.pos),q=p[0],v=p[1];u=[q+1,v+1],q=u[0],v=u[1]}w=s.turn===1?1:2;if((this.players[0]>0&&this.players[1]>0)||(this.replay_mode===true)){return r.frame=w}else{if(r.frame!==0){return r.tl.delay(s.delay*this.fps).scaleTo(0.1*this.scale,this.scale,0.2*this.fps).then(function(){return this.frame=w}).scaleTo(this.scale,this.scale,this.fps*0.2)}else{return r.tl.delay(s.delay*this.fps).then(function(){return this.frame=w})}}};o.prototype.putStone=function(C,K){var Q,J,R,B,O,N,I,H,M,G,P,A,L,F,E,v,t,D,z,w,u,s,r,q,p;if(K==null){K={delay:0,turn:this.turn}}if(!this.start){return n("[スタート！]を押してください！")}else{if((this.replay_mode===false)&&(this.BoardState[C]!==2)){return n("置けません！")}else{for(M=v=0,D=this.num_stone;0<=D?v<D:v>D;M=0<=D?++v:--v){if(this.BoardState[M]===2){this.BoardState[M]=0;this.SPRITES[M].frame=0}}z=this.pos2xy(C),F=z[0],E=z[1];n("("+(F+1)+", "+(E+1)+") に置きました！");this.recordPlay([this.turn,F+1,E+1]);L=(-1)*this.turn;for(M=t=0,w=m.length;0<=w?t<w:t>w;M=0<=w?++t:--t){u=[m[M][0],m[M][1]],I=u[0],H=u[1];s=[1,I,H],Q=s[0],O=s[1],N=s[2];while(this.isInBoard(F+O,E+N)&&(this.BoardState[this.xy2pos(F+O,E+N)]===L)){r=[Q+1,O+I,N+H],Q=r[0],O=r[1],N=r[2]}if(this.isInBoard(F+O,E+N)&&(this.BoardState[this.xy2pos(F+O,E+N)]===this.turn)){q=[Q-1,O-I,N-H],Q=q[0],O=q[1],N=q[2];while(Q>0){this.BoardState[this.xy2pos(F+O,E+N)]=this.turn;if(this.turn>0){this.BlackStone++;this.WhiteStone--}else{this.WhiteStone++;this.BlackStone--}A=this.xy2pos(F+O,E+N);this.showStone(this.SPRITES[A],{delay:K.delay+0.3,turn:this.turn,pos:A});p=[Q-1,O-I,N-H],Q=p[0],O=p[1],N=p[2]}}}this.BoardState[C]=this.turn;if(!this.SPRITES[C]){alert(C)}this.showStone(this.SPRITES[C],{delay:K.delay,turn:this.turn,pos:C});if(this.turn>0){this.BlackStone++}else{this.WhiteStone++}document.myForm.black.value=this.BlackStone;document.myForm.white.value=this.WhiteStone;this.turn*=-1;J=this.checkInvert();if(J.length===0){n(this.turn>0?"先手はパスです！":"後手はパスです！");this.recordPlay([this.turn,0,0]);this.turn*=-1;J=this.checkInvert();if(J.length===0){l("はじめから");G=this.gameResult();P=G===0?"引分け":G>0?"黒の勝ち":"白の勝ち";n("終了 ("+P+")");return}}if(((this.turn===1&&this.players[0]>0)||(this.turn===-1&&this.players[1]>0))&&(this.replay_mode===false)){R=this.turn===1?this.players[0]-1:this.players[1]-1;B=this.cpus[R].play(this.BoardState.slice(0),{turn:this.turn,canPuts:J.slice(0)});if(B!==null){this.putStone(B,{delay:K.delay+0.8,turn:this.turn})}}return null}}};o.prototype.gameResult=function(){var t,q,v,p,u;t=0;u=this.BoardState;for(v=0,p=u.length;v<p;v++){q=u[v];t+=q}return t};o.prototype.recordPlay=function(p){if(!this.replay_mode){if(this.play_pos!==this.records.length){this.records=this.records.slice(0,this.play_pos)}this.records.push(p);return this.play_pos=this.records.length}};o.prototype.exitReplay=function(){return this.replay_mode=false};o.prototype.replay=function(t,p){var q,s,r;this.replay_mode=true;this.firstScene();this.turn=1;if(p<0){p=0}if(p>t.length){p=t.length}if(p>0){for(q=r=0;0<=p?r<p:r>p;q=0<=p?++r:--r){s=(t[q][1]-1)+(t[q][2]-1)*this.gameSize;if(s>=0){this.turn=t[q][0];this.putStone(s)}}}if(p<=0){n("初期画面を表示しています。")}this.play_pos=p;return this.replay_mode=false};o.prototype.historyTop=function(){return this.replay(this.records,0)};o.prototype.historyLast=function(){return this.replay(this.records,this.records.length)};o.prototype.history=function(p){return this.replay(this.records,this.play_pos+p)};o.prototype.savePlay=function(){return alert(JSON.stringify({black:this.BlackStone,white:this.WhiteStone,play:this.records}))};o.prototype.loadPlay=function(){return console.log("未実装")};o.prototype.setPlayers=function(){return this.players=[document.myForm.first.selectedIndex,document.myForm.second.selectedIndex]};o.prototype.gameStart=function(){var p;if(!this.start){this.setPlayers();this.start=true;this.records=[];this.play_pos=0;n("ゲームスタート！！");l("やりなおす");p=this.checkInvert();if(this.players[0]>0&&p.length>0){return this.putStone(this.cpus[this.players[0]-1].play(this.BoardState.slice(0),{turn:this.turn,canPuts:p.slice(0)}))}}else{if(confirm("本当にやり直しますか？")){this.firstScene();this.turn=1;this.start=false;l("スタート！");return n("やりなおしました")}}};n=function(p){return document.myForm.myMsg.value=p};l=function(p){return document.myForm.start.value=p};return o})();enchant();window.onload=function(){var l,n,m,o;m=8;n=320;l=new Core(n+10,n+10);o=new b(l,m,Math.floor(n/m));this.reversi=o;o.setCPUs([new d(),new j(),new f(),new k(),new a(2),new a(3),new a(4),new a(5)].slice(0));l.onload=function(){var s,r,t,q,p;s=o.createBoard();p=[];for(t=0,q=s.length;t<q;t++){r=s[t];l.rootScene.addChild(r);p.push(r.addEventListener("touchend",function(){o.exitReplay();o.setPlayers();return o.putStone(this.pos)}))}return p};return l.start()};i=(function(){var m;function l(){}m=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];l.prototype.numStone=64;l.prototype.gameSize=8;l.prototype.play=function(o,n){if(n==null){n={}}};l.prototype.xy2pos=function(n,o){return n+o*this.gameSize};l.prototype.pos2xy=function(n){return[n%this.gameSize,Math.floor(n/this.gameSize)]};l.prototype.isInBoard=function(n,o){return(n>=0)&&(n<this.gameSize)&&(o>=0)&&(o<this.gameSize)};l.prototype.putStone=function(I,u,D,w){var K,J,H,E,C,v,G,F,B,z,r,A,t,s,q,p,o,n;if(w==null){w=false}if(I[u]!==0){return -1}F=D*(-1);v=0;A=this.pos2xy(u),B=A[0],z=A[1];for(G=r=0,t=m.length;0<=t?r<t:r>t;G=0<=t?++r:--r){s=[m[G][0],m[G][1]],E=s[0],C=s[1];q=[1,E,C],K=q[0],J=q[1],H=q[2];while(this.isInBoard(B+J,z+H)&&(I[this.xy2pos(B+J,z+H)]===F)){p=[K+1,J+E,H+C],K=p[0],J=p[1],H=p[2]}if(this.isInBoard(B+J,z+H)&&I[this.xy2pos(B+J,z+H)]===D){o=[K-1,J-E,H-C],K=o[0],J=o[1],H=o[2];while(K>0){if(w){I[this.xy2pos(B+J,z+H)]=D}n=[K-1,J-E,H-C],K=n[0],J=n[1],H=n[2];v++}}}if(w){I[u]=D}return v};l.prototype.checkInvert=function(v,C){var J,E,I,H,D,B,G,u,F,A,w,r,p,z,t,s,q,o,n;E=[];F=(-1)*C;for(u=r=0,z=this.numStone;0<=z?r<z:r>z;u=0<=z?++r:--r){if(v[u]===0){t=this.pos2xy(u),A=t[0],w=t[1];for(G=p=0,s=m.length;0<=s?p<s:p>s;G=0<=s?++p:--p){q=[m[G][0],m[G][1]],D=q[0],B=q[1];o=[1,D,B],J=o[0],I=o[1],H=o[2];while(this.isInBoard(A+I,w+H)&&(v[this.xy2pos(A+I,w+H)]===F)){n=[J+1,I+D,H+B],J=n[0],I=n[1],H=n[2]}if(this.isInBoard(A+I,w+H)&&(v[this.xy2pos(A+I,w+H)]===C)&&(J>1)){E.push(u);break}}}}return E};return l})();d=(function(){function l(){}l.prototype.play=function(n,m){if(m==null){m={}}if(m.canPuts.length===0){return null}else{return m.canPuts[0]}};return l})();j=(function(){function l(){}l.prototype.play=function(n,m){if(m==null){m={}}if(m.canPuts.length===0){return null}else{return m.canPuts[Math.floor(Math.random()*m.canPuts.length)]}};return l})();f=(function(m){c(l,m);function l(){}l.prototype.play=function(o,n){var A,w,q,v,y,p,x,t,s,z,u,r;if(n==null){n={}}x=n.turn;A=null;q={};w=-1;for(v=t=0,u=this.numStone;0<=u?t<u:t>u;v=0<=u?++t:--t){if(o[v]===2){o[v]=0}}r=n.canPuts;for(s=0,z=r.length;s<z;s++){y=r[s];p=this.putStone(o,y,x,false);if(w<p){w=p}if(q[p]){q[p].push(y)}else{q[p]=[y]}}console.log("#--- AI_gains ");console.log(q);y=w<=0?nyll:q[w][Math.floor(Math.random()*q[w].length)];console.log("#--- AI_Gain turn:"+x+", pos:"+y);return y};return l})(i);k=(function(n){var m;c(l,n);function l(){e=l.__super__.constructor.apply(this,arguments);return e}m=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];l.prototype.numStone=64;l.prototype.gameSize=8;l.prototype.playCount=5;l.prototype.play=function(E,A){var C,q,D,B,x,y,w,G,H,F,z,t,r,o,I,v,u,s;if(A==null){A={}}y=A.turn;C=null;F={};G=-1;for(D=t=0,v=this.numStone;0<=v?t<v:t>v;D=0<=v?++t:--t){if(E[D]===2){E[D]=0}}G=-1;F={};u=A.canPuts;for(r=0,I=u.length;r<I;r++){x=u[r];w=0;q=0;for(B=o=0,s=this.playCount;0<=s?o<s:o>s;B=0<=s?++o:--o){z=E.slice(0);H=this.playGame(z,y,x);if(H===y){w++}if(H===0){q++}}if(w===0&&q===0){w=-1}if(F[w]){F[w].push(x)}else{F[w]=[x]}if(G<w){G=w}}console.log("#--- AI_Montecarlo(playCount="+this.playCount+" turn:"+y+", pos:"+F[G][0]);return F[G][0]};l.prototype.playGame=function(s,u,t){var o,q,w,r,p,v;w=0;while(w<2){if(t>=0){this.putStone(s,t,u,true)}u*=-1;o=this.checkInvert(s,u);if(o.length===0){t=null;w++}else{t=o[Math.floor(Math.random()*o.length)];w=0}}r=0;for(p=0,v=s.length;p<v;p++){q=s[p];r+=q}if(r===0){return 0}if(r>0){return 1}else{return -1}};return l})(i);g=(function(){function l(){}l.rate9=[127,-32,0,-1,-1,-1,0,-32,127,-32,-64,-1,-1,-1,-1,-1,-64,-32,0,-1,0,-1,-1,-1,0,-1,0,-1,-1,-1,0,0,0,-1,-1,-1,-1,-1,-1,0,0,0,-1,-1,-1,-1,-1,-1,0,0,0,-1,-1,-1,0,-1,0,-1,-1,-1,0,-1,0,-32,-64,-1,-1,-1,-1,-1,-64,-32,127,-32,0,-1,-1,-1,0,-32,127];l.rate8=[127,-32,0,-1,-1,0,-32,127,-32,-64,-1,-1,-1,-1,-64,-32,0,-1,0,-1,-1,0,-1,0,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,0,-1,0,-1,-1,0,-1,0,-32,-64,-1,-1,-1,-1,-64,-32,127,-32,0,-1,-1,0,-32,127];l.rate7=[127,-32,0,-1,0,-32,127,-32,-64,-1,-1,-1,-64,-32,0,-1,0,-1,0,-1,0,-1,-1,-1,0,-1,-1,-1,0,-1,0,-1,0,-1,0,-32,-64,-1,-1,-1,-64,-32,127,-32,0,-1,0,-32,127];l.rate6=[127,-32,0,0,-32,127,-32,-64,-1,-1,-64,-32,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-32,-64,-1,-1,-64,-32,127,-32,0,0,-32,127];l.rate5=[127,-32,0,-32,127,-32,-64,-1,-64,-32,0,-1,0,-1,0,-32,-64,-1,-64,-32,127,-32,0,-32,127];l.rate4=[127,-32,-32,127,-32,-64,-64,-32,-32,-64,-64,-32,127,-32,-32,127];l.evalBoard=function(t,m,s){var v,u,n,r,q,p,o;u=l["rate"+m];n=0;if(s==="gain"){for(v=r=0,p=u.length;0<=p?r<p:r>p;v=0<=p?++r:--r){n+=t[v]}}else{for(v=q=0,o=u.length;0<=o?q<o:q>o;v=0<=o?++q:--q){n+=t[v]*u[v]}}return n};return l})();a=(function(l){c(m,l);function m(n,o){this.depth=n!=null?n:5;this.gameSize=o!=null?o:8}m.prototype.play=function(p,n){var t,u,w,o,y,A,x,z,s,r,q;if(n==null){n={}}x=n.turn;o=0;for(u=s=0,r=this.numStone;0<=r?s<r:s>r;u=0<=r?++s:--s){if(p[u]===2){p[u]=0}if(p[u]===0){o++}}t=this.depth;w="";if(o<=10){w="gain";t=o}q=this.negaMax(t,p,x,w),z=q[0],A=q[1];y=A[Math.floor(Math.random()*A.length)];console.log("#--- AI_Negamax(depth="+this.depth+" turn:"+x+", pos:"+y+", v="+z);return y};m.prototype.negaMax=function(q,x,z,t){var u,n,o,r,s,y,B,w,p,A;if(q===0){return[g.evalBoard(x,this.gameSize,t)*z,null]}n=-32000;u={};w=x.slice(0);o=this.checkInvert(w,z);for(p=0,A=o.length;p<A;p++){y=o[p];s=w.slice(0);this.putStone(s,y,z,true);r=this.negaMax(q-1,s,(-1)*z,t);B=(-1)*r[0];if(u[B]){u[B].push(y)}else{u[B]=[y]}if(n<=B){n=B}}return[n,u[n]]};return m})(i)}).call(this);