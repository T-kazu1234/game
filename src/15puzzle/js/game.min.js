(function(){var a={}.hasOwnProperty,b=function(f,d){for(var c in d){if(a.call(d,c)){f[c]=d[c]}}function e(){this.constructor=f}e.prototype=d.prototype;f.prototype=new e();f.__super__=d.prototype;return f};$(function(){var j,e,n,l,k,h,f,c,m,g,o,i,d;enchant();j="./sounds/bgm01.wav";n="images/enchant.png";l=["images/start.png",n,j];m=null;o=function(r,p){var t,q,s;if(p==null){p=""}r=r.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");q="[\\?&]"+r+"=([^&#]*)";t=new RegExp(q);s=t.exec(window.location.search);if(s===null){return p}else{return decodeURIComponent(s[1].replace(/\+/g," "))}};i=function(p){return Math.floor(Math.random()*p)};d=function(p){return p[i(p.length)]};k=(function(p){b(q,p);function q(t,s){var r,u,w,v;this.conf=t;this.position=s!=null?s:0;q.__super__.constructor.call(this,t.cell_w,t.cell_h);this.moved=false;r=new Surface(t.cell_w,t.cell_h);v=[(s%4)*t.cell_w,(Math.floor(s/4))*t.cell_h],u=v[0],w=v[1];r.draw(m.assets[n],u,w,t.cell_w,t.cell_h,0,0,t.cell_w,t.cell_h);r.context.rect(0,0,t.cell_w,t.cell_h);r.context.strokeStyle="#666666";r.context.stroke();this.image=r;this.on("touchstart",function(){if(!this.moved){return this.tl.fadeTo(0.5,1)}});this.on("touchend",function(){var E,A,z,F,I,G,D,H,C,B;if(!this.moved){this.tl.fadeTo(1,1);z=this.parentNode.childNodes;C=[[1,0],[0,1],[-1,0],[0,-1]];B=[];for(D=0,H=C.length;D<H;D++){E=C[D];if(this.moved){break}I=E[0],G=E[1];B.push((function(){var J,x,y;y=[];for(J=0,x=z.length;J<x;J++){A=z[J];F=A.position;if(F===this.position+I+G*this.conf.cell_x){if(A.x===320){A.position=this.position;this.position=F;this.moved=true;this.tl.moveTo((this.position%this.conf.cell_x)*this.conf.cell_w,Math.floor(this.position/this.conf.cell_x)*this.conf.cell_h,3,QUAD_EASEOUT);this.tl.then(function(){this.moved=false;return m.checkFinish()});break}else{y.push(void 0)}}else{y.push(void 0)}}return y}).call(this))}return B}})}return q})(Sprite);e=(function(){function p(r){var s,q,u,t;this.conf=r;this.panels=[];for(s=u=0,t=r.celles;0<=t?u<t:u>t;s=0<=t?++u:--u){q=new k(r,s);m.rootScene.addChild(q);this.panels.push(q)}this.shuffle()}p.prototype.shuffle=function(){var r,s,q;q=[];for(r=s=1;s<10;r=++s){this.do_shuffle();if(this.checkFinish()===false){break}else{q.push(void 0)}}return q};p.prototype.do_shuffle=function(){var E,F,B,q,D,C,H,G,z,w,t,A,v,s,r,u;D=(function(){u=[];for(var y=0,x=this.conf.celles;0<=x?y<x:y>x;0<=x?y++:y--){u.push(y)}return u}).apply(this);this.hideCell_idx=null;for(B=w=0,v=this.conf.celles;0<=v?w<v:w>v;B=0<=v?++w:--w){this.panels[B].position=B;this.panels[B].frame=B;this.panels[B].x=(this.panels[B].position%this.conf.cell_x)*this.conf.cell_w;this.panels[B].y=Math.floor(this.panels[B].position/this.conf.cell_x)*this.conf.cell_h;this.panels[B].moved=false}q=i(this.conf.celles);E=this.conf.shuffle;while(E>0){s=d([[1,0],[0,1],[-1,0],[0,-1]]),H=s[0],G=s[1];if(!((q%this.conf.cell_x===0&&H<0)||(q%this.conf.cell_x===(this.conf.cell_x-1)&&H>0)||(q<this.conf.cell_y&&G<0)||(q>(this.conf.celles-this.conf.cell_x-1)&&G>0))){F=q+H+G*this.conf.cell_x;C=D[q];D[q]=D[F];D[F]=C;q=F;E--}}this.hideCell_idx=q;for(B=t=0,r=this.conf.celles;0<=r?t<r:t>r;B=0<=r?++t:--t){this.panels[B].position=D[B];this.panels[B].x=(this.panels[B].position%this.conf.cell_x)*this.conf.cell_w;this.panels[B].y=Math.floor(this.panels[B].position/this.conf.cell_x)*this.conf.cell_h}if(this.hideCell_idx!==null){return this.panels[this.hideCell_idx].x=this.panels[this.hideCell_idx].y=320}};p.prototype.checkFinish=function(){var r,q,t,s;q=true;for(r=t=0,s=this.conf.celles;0<=s?t<s:t>s;r=0<=s?++t:--t){if(this.panels[r].position!==parseInt(r,10)){q=false}}return q};p.prototype.gameover=function(){var q=this;this.panels[this.hideCell_idx].tl.moveTo((this.panels[this.hideCell_idx].position%this.conf.cell_x)*this.conf.cell_w,Math.floor(this.panels[this.hideCell_idx].position/this.conf.cell_x)*this.conf.cell_h,m.fps/2,QUAD_EASEOUT);return this.panels[this.hideCell_idx].tl.then(function(){var r,s;s=new Date().getTime()-m.startTime;alert(""+((s/1000).toFixed(2))+" 秒でクリア！");r=f();m.pushScene(r);return q.shuffle()})};return p})();c=function(){var r,q,p;q=new Scene();r=new Sprite(236,48);r.image=m.assets["images/start.png"];p=[42,136],r.x=p[0],r.y=p[1];q.addChild(r);q.addEventListener(Event.TOUCH_START,function(s){m.popScene();return m.startTime=new Date().getTime()});return q};f=function(){var r,q,p;q=new Scene();r=new Sprite(320,320);r.image=m.assets["images/enchant.png"];p=[0,0],r.x=p[0],r.y=p[1];q.addChild(r);q.addEventListener(Event.TOUCH_START,function(s){return m.popScene()});return q};g=function(){var p,t,s,r,q;t=parseInt(o("x",4),10);s=parseInt(o("y",4),10);q=parseInt(o("s",100),10);p=parseInt(o("b",1),10);return r={cell_x:t,cell_y:s,celles:t*s,cell_w:320/t,cell_h:320/s,shuffle:q,bgm:p}};m=new Game(320,320);m.fps=24;m.preload(l);h=g();m.onload=function(){var q,r,p;m.rootScene.backgroundColor="#000000";r=new e(h);m.pushScene(c());q=m.assets[j];m.checkFinish=function(){if(r.checkFinish()){return r.gameover()}};$("#bgm-on").click(function(){return p(false)});$("#bgm-off").click(function(){return p(true)});$("#shuffle").click(function(){var u,v,t,w;t=$("#cell-x").val();w=$("#cell-y").val();v=h.shuffle;u=$("#bgm-on").css("display")==="none"?0:1;return window.location="./index.html?x="+t+"&y="+w+"&s="+v+"&b="+u});p=function(s){if(s){$("#bgm-on").show();$("#bgm-off").hide();q.play();if(q._element){q._element.loop=true}if(q.src){return q.src.loop=true}}else{$("#bgm-on").hide();$("#bgm-off").show();return q.pause()}};$("#cell-x").val(h.cell_x);$("#cell-y").val(h.cell_y);return p(h.bgm===1)};return m.start()})}).call(this);